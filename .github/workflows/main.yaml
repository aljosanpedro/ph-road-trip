name: "godot-ci export"

on:
    push:
      tags:
        - "v*"
  

# NOTE: If your `project.godot` is at the repository root, set `PROJECT_PATH` below to ".".

env:
    GODOT_VERSION: 4.4.1
    EXPORT_NAME: game
    PROJECT_PATH: .

  
jobs:
    export-windows:
        permissions: write-all
        name: Windows/Web Export
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v4
            with:
              lfs: true

          - name: export game
            id: export
            # Use latest version (see releases for all versions)
            uses: firebelley/godot-export@v6.0.0
            with:
              # Defining all the required inputs
              godot_executable_download_url: https://github.com/godotengine/godot-builds/releases/download/4.4.1-stable/Godot_v4.4.1-stable_linux.x86_64.zip
              godot_export_templates_download_url: https://github.com/godotengine/godot-builds/releases/download/4.4.1-stable/Godot_v4.4.1-stable_export_templates.tpz
              relative_project_path: ./
              archive_output: true

          - name: Upload Artifact
            id: upload_artifact_windows
            uses: actions/upload-artifact@v4
            with:
              name: windows
              path: build/windows

          - name: Upload Artifact
            id: upload_artifact_web
            uses: actions/upload-artifact@v4
            with:
              name: web
              path: build/web
            
  

            # - name: Install rsync ðŸ“š
            #   run: |
            #     apt-get update && apt-get install -y rsync

            # # - name: Deploy to GitHub Pages ðŸš€
            # #     uses: JamesIves/github-pages-deploy-action@releases/v4
            # #     with:
            # #     branch: gh-pages # The branch the action should deploy to.
            # #     folder: build/web # The folder the action should deploy.

            # - name: Add coi-service-worker
            #   run: |
            #     git clone https://github.com/gzuidhof/coi-serviceworker.git
            #     mv coi-serviceworker/coi-serviceworker.js build/web/coi-serviceworker.js
            #     sed -i '3 i <script src="coi-serviceworker.js"></script>' build/web/index.html

            # - name: Deploy
            #   uses: peaceiris/actions-gh-pages@v4
            #   with:
            #     github_token: ${{ secrets.GITHUB_TOKEN }}
            #     publish_dir: ./build/web
            #     force_orphan: true
            #     user_name: "github-ci[bot]"
            #     user_email: "github-actions[bot]@users.noreply.github.com"
            #     commit_message: "Publish to gh-pages"

    create-release:
        permissions: write-all
        needs: export-windows
        name: Creating Releases for Windows/Web
        runs-on: ubuntu-latest
        steps:
            - name: Download Windows Artifact
              uses: actions/download-artifact@v4
              with:
                name: windows
                path: build/windows
            
            - name: Download Web Artifact
              uses: actions/download-artifact@v4
              with:
                name: web
                path: build/web/


            - name: Zipping for Windows Release
              run: |
                cd build/windows/
                zip -r windows_${{  github.ref_name }}.zip *

            - name: Zipping for Web Release
              run: |
                cd build/web/
                zip -r web_${{  github.ref_name }}.zip *

            - name: Creating Release
              uses: ncipollo/release-action@v1.14.0
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                generateReleaseNotes: true
                tag: ${{ github.ref_name }}
                artifacts: "build/web/web_${{  github.ref_name }}.zip,build/windows/windows_${{  github.ref_name }}.zip"
    
    publish-on-github-pages:
      permissions: write-all
      needs: export-windows
      name: Publishing on Github Pages
      runs-on: ubuntu-latest
      steps:
        - name: Download Web Artifact
          uses: actions/download-artifact@v4
          with:
            name: web
            path: build/web/

        - name: Install rsync ðŸ“š
          run: |
            sudo apt-get update && sudo apt-get install -y rsync

        - name: Add coi-service-worker
          run: |
            git clone https://github.com/gzuidhof/coi-serviceworker.git
            mv coi-serviceworker/coi-serviceworker.js build/web/coi-serviceworker.js
            sed -i '3 i <script src="coi-serviceworker.js"></script>' build/web/index.html

        - name: Deploy
          uses: peaceiris/actions-gh-pages@v4
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: ./build/web
            force_orphan: true
            user_name: "github-ci[bot]"
            user_email: "github-actions[bot]@users.noreply.github.com"
            commit_message: "Publish to gh-pages"
            
